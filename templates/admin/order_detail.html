{% extends "base.html" %}

{% block title %}Order #{{ order.id }} | Admin | PantiesFan.com{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<style>
    .order-detail-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        margin-bottom: 3rem;
    }
    .detail-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 4px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .detail-card h3 {
        font-size: 0.85rem;
        color: var(--accent-gold);
        font-family: 'Montserrat', sans-serif;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--glass-border);
    }
    .detail-card h3 i { margin-right: 0.4rem; }
    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 0.4rem 0;
        border-bottom: 1px solid rgba(255,255,255,0.03);
    }
    .detail-row:last-child { border-bottom: none; }
    .detail-row .label { color: var(--text-muted); font-size: 0.85rem; }
    .detail-row .value { color: var(--text-main); font-weight: 500; font-size: 0.9rem; }

    .order-status-banner {
        display: flex;
        gap: 1.5rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    .status-card {
        flex: 1;
        min-width: 140px;
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 4px;
        padding: 1rem 1.2rem;
        text-align: center;
    }
    .status-card .sc-label {
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-muted);
        margin-bottom: 0.3rem;
    }
    .status-card .sc-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-main);
    }

    /* Timeline */
    .timeline { position: relative; padding-left: 2rem; }
    .timeline::before {
        content: '';
        position: absolute;
        left: 8px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--glass-border);
    }
    .timeline-item {
        position: relative;
        margin-bottom: 1.5rem;
        padding-left: 1.5rem;
    }
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -1.55rem;
        top: 0.3rem;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--accent-gold);
        border: 2px solid #1a1a2e;
    }
    .timeline-date {
        font-size: 0.7rem;
        color: var(--text-muted);
        margin-bottom: 0.2rem;
    }
    .timeline-action {
        font-size: 0.9rem;
        color: var(--text-main);
        font-weight: 500;
    }
    .timeline-admin {
        font-size: 0.75rem;
        color: var(--text-muted);
    }
    .timeline-details {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 0.3rem;
        padding: 0.5rem;
        background: rgba(255,255,255,0.02);
        border-radius: 2px;
        font-family: monospace;
        word-break: break-all;
    }
    .timeline-empty {
        color: var(--text-muted);
        font-style: italic;
        padding: 1rem 0;
    }

    /* Danger zone */
    .danger-zone {
        border-color: rgba(244, 67, 54, 0.3) !important;
        background: rgba(244, 67, 54, 0.03) !important;
    }
    .danger-zone h3 { color: #e57373 !important; border-color: rgba(244, 67, 54, 0.2) !important; }

    /* Quick action forms */
    .quick-actions .admin-btn {
        width: 100%;
        justify-content: center;
        margin-bottom: 0.5rem;
    }

    /* Sidebar edit form */
    .sidebar-form .form-group {
        margin-bottom: 1rem;
    }
    .sidebar-form label {
        display: block;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-muted);
        margin-bottom: 0.3rem;
    }
    .sidebar-form select,
    .sidebar-form input,
    .sidebar-form textarea {
        width: 100%;
        padding: 0.5rem;
        background: rgba(255,255,255,0.05);
        border: 1px solid var(--glass-border);
        border-radius: 3px;
        color: var(--text-main);
        font-size: 0.85rem;
    }
    .sidebar-form textarea { resize: vertical; min-height: 60px; }

    @media (max-width: 768px) {
        .order-detail-grid { grid-template-columns: 1fr; }
        .order-status-banner { flex-direction: column; }
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <div>
            <h1>Order #{{ order.id }}</h1>
            <p style="color: var(--text-muted); margin-top: 0.3rem;">{{ order.auction_title }}</p>
        </div>
        <div class="admin-actions">
            <a href="{{ url_for('admin_orders') }}" class="admin-btn"><i class="fas fa-arrow-left"></i> All Orders</a>
        </div>
    </div>

    <!-- Status Banner -->
    <div class="order-status-banner">
        <div class="status-card">
            <div class="sc-label">Payment Status</div>
            <div class="sc-value"><span class="status-badge status-{{ order.status }}">{{ order.status|upper }}</span></div>
        </div>
        <div class="status-card">
            <div class="sc-label">Amount</div>
            <div class="sc-value" style="color: var(--accent-gold);">${{ "%.2f"|format(order.amount) }}</div>
        </div>
        <div class="status-card">
            <div class="sc-label">Shipping</div>
            <div class="sc-value">${{ "%.2f"|format(order.shipping_cost or 0) }}</div>
        </div>
        <div class="status-card">
            <div class="sc-label">Processor</div>
            <div class="sc-value">{{ order.processor or '&mdash;' }}</div>
        </div>
    </div>

    <div class="order-detail-grid">
        <!-- LEFT COLUMN: Info cards -->
        <div class="order-main">

            <!-- Order Info -->
            <div class="detail-card">
                <h3><i class="fas fa-receipt"></i> Order Information</h3>
                <div class="detail-row">
                    <span class="label">Order ID</span>
                    <span class="value">#{{ order.id }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Auction</span>
                    <span class="value">{{ order.auction_title }} (#{{ order.auction_id }})</span>
                </div>
                <div class="detail-row">
                    <span class="label">Muse</span>
                    <span class="value">{{ order.muse_name or 'N/A' }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Category</span>
                    <span class="value">{{ order.category or 'N/A' }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Transaction ID</span>
                    <span class="value">{{ order.processor_txn or '&mdash;' }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Created</span>
                    <span class="value">{{ order.created_at }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Completed</span>
                    <span class="value">{{ order.completed_at or '&mdash;' }}</span>
                </div>
                {% if order.admin_notes %}
                <div class="detail-row">
                    <span class="label">Admin Notes</span>
                    <span class="value">{{ order.admin_notes }}</span>
                </div>
                {% endif %}
            </div>

            <!-- Buyer Info -->
            <div class="detail-card">
                <h3><i class="fas fa-user"></i> Buyer Information</h3>
                <div class="detail-row">
                    <span class="label">Name</span>
                    <span class="value">{{ order.buyer_name }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Email</span>
                    <span class="value">{{ order.buyer_email }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Member Since</span>
                    <span class="value">{{ order.buyer_since[:10] if order.buyer_since else 'N/A' }}</span>
                </div>
            </div>

            <!-- Shipping Address -->
            <div class="detail-card">
                <h3><i class="fas fa-map-marker-alt"></i> Shipping Address</h3>
                {% if order.ship_name %}
                <div class="detail-row">
                    <span class="label">Recipient</span>
                    <span class="value">{{ order.ship_name }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Address</span>
                    <span class="value">{{ order.address_line1 }}{% if order.address_line2 %}, {{ order.address_line2 }}{% endif %}</span>
                </div>
                <div class="detail-row">
                    <span class="label">City / State</span>
                    <span class="value">{{ order.city }}{% if order.state %}, {{ order.state }}{% endif %}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Postal / Country</span>
                    <span class="value">{{ order.postal_code }}, {{ order.country }}</span>
                </div>
                {% if order.phone %}
                <div class="detail-row">
                    <span class="label">Phone</span>
                    <span class="value">{{ order.phone }}</span>
                </div>
                {% endif %}
                {% else %}
                <p style="color: var(--text-muted); font-style: italic;">No shipping address on file.</p>
                {% endif %}
            </div>

            <!-- Shipment Info -->
            {% if order.shipment_id %}
            <div class="detail-card">
                <h3><i class="fas fa-truck"></i> Shipment Details</h3>
                <div class="detail-row">
                    <span class="label">Status</span>
                    <span class="value"><span class="status-badge status-{{ order.shipment_status }}">{{ order.shipment_status|upper }}</span></span>
                </div>
                {% if order.tracking_number %}
                <div class="detail-row">
                    <span class="label">Tracking</span>
                    <span class="value">{{ order.tracking_number }}</span>
                </div>
                {% endif %}
                <div class="detail-row">
                    <span class="label">Carrier</span>
                    <span class="value">{{ order.carrier or 'DHL' }}</span>
                </div>
                {% if order.shipped_at %}
                <div class="detail-row">
                    <span class="label">Shipped At</span>
                    <span class="value">{{ order.shipped_at }}</span>
                </div>
                {% endif %}
                {% if order.delivered_at %}
                <div class="detail-row">
                    <span class="label">Delivered At</span>
                    <span class="value">{{ order.delivered_at }}</span>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Recent Bids -->
            {% if bids %}
            <div class="detail-card">
                <h3><i class="fas fa-gavel"></i> Recent Bids ({{ bids|length }})</h3>
                <div class="table-wrapper">
                    <table class="admin-table" style="font-size: 0.85rem;">
                        <thead>
                            <tr>
                                <th>Bidder</th>
                                <th>Amount</th>
                                <th>Winning</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for b in bids %}
                            <tr>
                                <td>{{ b.bidder_name }}</td>
                                <td class="price-cell">${{ "%.2f"|format(b.amount) }}</td>
                                <td>{% if b.is_winning %}<i class="fas fa-check" style="color: #81c784;"></i>{% else %}&mdash;{% endif %}</td>
                                <td><small>{{ b.placed_at }}</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

        </div>

        <!-- RIGHT COLUMN: Actions + Edit -->
        <div class="order-sidebar">

            <!-- Quick Actions -->
            <div class="detail-card quick-actions">
                <h3><i class="fas fa-bolt"></i> Quick Actions</h3>

                {% if order.status == 'pending' %}
                <form method="POST" action="{{ url_for('admin_mark_paid', payment_id=order.id) }}"
                      onsubmit="return confirm('Mark this payment as confirmed?')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="admin-btn primary">
                        <i class="fas fa-check-circle"></i> Verify Payment
                    </button>
                </form>
                {% endif %}

                {% if order.status == 'paid' %}
                <form method="POST" action="{{ url_for('admin_ship_order', payment_id=order.id) }}"
                      onsubmit="var tn = prompt('Enter tracking number:'); if(!tn) return false; this.querySelector('[name=tracking_number]').value = tn; return confirm('Ship this order?')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="tracking_number" value="">
                    <input type="hidden" name="carrier" value="DHL">
                    <button type="submit" class="admin-btn primary">
                        <i class="fas fa-truck"></i> Ship Order
                    </button>
                </form>
                {% endif %}

                {% if order.status == 'shipped' %}
                <form method="POST" action="{{ url_for('admin_deliver_order', payment_id=order.id) }}"
                      onsubmit="return confirm('Mark this order as delivered?')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="admin-btn primary">
                        <i class="fas fa-box-open"></i> Mark Delivered
                    </button>
                </form>
                {% endif %}

                {% if order.status == 'completed' %}
                <p style="color: #81c784; text-align: center; padding: 0.5rem;">
                    <i class="fas fa-check-double"></i> Order Complete
                </p>
                {% endif %}

                {% if order.status == 'awaiting_payment' %}
                <p style="color: var(--text-muted); text-align: center; padding: 0.5rem; font-style: italic;">
                    Waiting for buyer payment...
                </p>
                {% endif %}
            </div>

            <!-- Edit Order -->
            <div class="detail-card sidebar-form">
                <h3><i class="fas fa-edit"></i> Edit Order</h3>
                <form method="POST" action="{{ url_for('admin_order_edit', payment_id=order.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <div class="form-group">
                        <label>Status Override</label>
                        <select name="status">
                            {% for s in ['awaiting_payment', 'pending', 'paid', 'shipped', 'completed'] %}
                            <option value="{{ s }}" {% if order.status == s %}selected{% endif %}>{{ s|replace('_', ' ')|title }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Tracking Number</label>
                        <input type="text" name="tracking_number" value="{{ order.tracking_number or '' }}" placeholder="e.g. DHL123456789">
                    </div>

                    <div class="form-group">
                        <label>Carrier</label>
                        <select name="carrier">
                            {% for c in ['DHL', 'FedEx', 'UPS', 'USPS', 'Thai Post', 'Other'] %}
                            <option value="{{ c }}" {% if (order.carrier or 'DHL') == c %}selected{% endif %}>{{ c }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Admin Notes</label>
                        <textarea name="admin_notes" placeholder="Internal notes...">{{ order.admin_notes or '' }}</textarea>
                    </div>

                    <button type="submit" class="admin-btn primary" style="width: 100%; justify-content: center;">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </form>
            </div>

            <!-- Danger Zone -->
            {% if order.status == 'awaiting_payment' %}
            <div class="detail-card danger-zone">
                <h3><i class="fas fa-exclamation-triangle"></i> Danger Zone</h3>
                <form method="POST" action="{{ url_for('admin_order_delete', payment_id=order.id) }}"
                      onsubmit="return confirm('Are you sure you want to delete this order?') && confirm('This action cannot be undone. REALLY delete?')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="admin-btn" style="width: 100%; justify-content: center; color: #e57373; border-color: #e57373;">
                        <i class="fas fa-trash"></i> Delete Order
                    </button>
                </form>
            </div>
            {% endif %}

        </div>
    </div>

    <!-- Audit Timeline -->
    <div class="admin-section">
        <h2><i class="fas fa-history" style="color: var(--accent-gold); margin-right: 0.5rem;"></i>Order Timeline</h2>
        {% if timeline %}
        <div class="timeline">
            {% for entry in timeline %}
            <div class="timeline-item">
                <div class="timeline-date">{{ entry.created_at }}</div>
                <div class="timeline-action">{{ entry.action|replace('_', ' ')|title }}</div>
                <div class="timeline-admin">by {{ entry.admin_name or 'System' }}</div>
                {% if entry.details %}
                <div class="timeline-details">{{ entry.details }}</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="timeline-empty">No history recorded yet. Actions taken on this order will appear here.</p>
        {% endif %}
    </div>

</div>
{% endblock %}
