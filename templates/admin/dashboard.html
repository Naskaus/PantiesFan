{% extends "base.html" %}

{% block title %}Admin Dashboard | PantiesFan.com{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}

<div class="admin-container">
    <div class="admin-header">
        <h1>Admin Dashboard</h1>
        <div class="admin-actions">
            <a href="{{ url_for('admin_auction_new') }}" class="admin-btn primary"><i class="fas fa-plus"></i> New Auction</a>
            <a href="{{ url_for('admin_orders') }}" class="admin-btn"><i class="fas fa-receipt"></i> Orders</a>
            <a href="{{ url_for('admin_users') }}" class="admin-btn"><i class="fas fa-user-cog"></i> Users</a>
            <a href="{{ url_for('admin_muses') }}" class="admin-btn"><i class="fas fa-users"></i> Manage Muses</a>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-gavel"></i></div>
            <div class="stat-value">{{ stats.total_auctions }}</div>
            <div class="stat-label">Total Auctions</div>
        </div>
        <div class="stat-card live">
            <div class="stat-icon"><i class="fas fa-circle"></i></div>
            <div class="stat-value">{{ stats.live_auctions }}</div>
            <div class="stat-label">Live Now</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-flag-checkered"></i></div>
            <div class="stat-value">{{ stats.ended_auctions }}</div>
            <div class="stat-label">Ended</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-hand-paper"></i></div>
            <div class="stat-value">{{ stats.total_bids }}</div>
            <div class="stat-label">Total Bids</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-user"></i></div>
            <div class="stat-value">{{ stats.total_users }}</div>
            <div class="stat-label">Buyers</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-star"></i></div>
            <div class="stat-value">{{ stats.total_muses }}</div>
            <div class="stat-label">Muses</div>
        </div>
        <div class="stat-card accent">
            <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
            <div class="stat-value">${{ "%.2f"|format(stats.total_gmv) }}</div>
            <div class="stat-label">GMV (Ended)</div>
        </div>
    </div>

    <!-- Fulfillment Pipeline Alert -->
    {% if stats.orders_need_action > 0 or stats.orders_shipped > 0 %}
    <div class="fulfillment-alert-section">

        <!-- Alert Banner -->
        {% if stats.orders_need_action > 0 %}
        <div class="fulfillment-alert">
            <div class="alert-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="alert-content">
                <strong>{{ stats.orders_need_action }} order{{ 's' if stats.orders_need_action != 1 else '' }} need{{ '' if stats.orders_need_action != 1 else 's' }} your attention</strong>
                <span>
                    {% if stats.orders_pending_verification > 0 %}
                        {{ stats.orders_pending_verification }} pending verification
                    {% endif %}
                    {% if stats.orders_pending_verification > 0 and stats.orders_ready_to_ship > 0 %}&bull;{% endif %}
                    {% if stats.orders_ready_to_ship > 0 %}
                        {{ stats.orders_ready_to_ship }} ready to ship
                    {% endif %}
                </span>
            </div>
            <a href="{{ url_for('admin_orders') }}" class="admin-btn primary small">
                <i class="fas fa-arrow-right"></i> Go to Orders
            </a>
        </div>
        {% endif %}

        <!-- Pipeline Status Milestones -->
        <div class="pipeline-milestones">
            <h3><i class="fas fa-shipping-fast"></i> Fulfillment Pipeline</h3>
            <div class="pipeline-track">
                <div class="pipeline-stage {% if stats.orders_awaiting_payment > 0 %}active{% endif %}">
                    <div class="pipeline-count">{{ stats.orders_awaiting_payment }}</div>
                    <div class="pipeline-dot awaiting"></div>
                    <div class="pipeline-label">Awaiting Payment</div>
                </div>
                <div class="pipeline-connector"></div>
                <div class="pipeline-stage {% if stats.orders_pending_verification > 0 %}active needs-action{% endif %}">
                    <div class="pipeline-count">{{ stats.orders_pending_verification }}</div>
                    <div class="pipeline-dot pending"></div>
                    <div class="pipeline-label">Verify Payment</div>
                </div>
                <div class="pipeline-connector"></div>
                <div class="pipeline-stage {% if stats.orders_ready_to_ship > 0 %}active needs-action{% endif %}">
                    <div class="pipeline-count">{{ stats.orders_ready_to_ship }}</div>
                    <div class="pipeline-dot paid"></div>
                    <div class="pipeline-label">Ready to Ship</div>
                </div>
                <div class="pipeline-connector"></div>
                <div class="pipeline-stage {% if stats.orders_shipped > 0 %}active{% endif %}">
                    <div class="pipeline-count">{{ stats.orders_shipped }}</div>
                    <div class="pipeline-dot shipped"></div>
                    <div class="pipeline-label">In Transit</div>
                </div>
            </div>
        </div>

        <!-- Actionable Orders Mini-Table (privacy-safe: NO buyer PII) -->
        {% if actionable_orders %}
        <div class="actionable-orders">
            <div class="actionable-header">
                <h3>Orders Requiring Action</h3>
                <a href="{{ url_for('admin_orders') }}" class="admin-btn small">View All Orders <i class="fas fa-external-link-alt"></i></a>
            </div>
            <div class="table-wrapper">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Order</th>
                            <th>Item</th>
                            <th>Muse</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for o in actionable_orders %}
                        <tr class="{% if o['payment_status'] == 'paid' %}row-action-ship{% elif o['payment_status'] == 'pending' %}row-action-verify{% else %}row-action-deliver{% endif %}">
                            <td>#{{ o['payment_id'] }}</td>
                            <td>
                                <div class="item-cell">
                                    {% if o['auction_image'] %}
                                    <div class="table-thumb">
                                        {% if o['auction_image'].startswith('uploads/') %}
                                        <img src="{{ url_for('static', filename=o['auction_image']) }}" alt="">
                                        {% else %}
                                        <img src="{{ url_for('static', filename='images/' + o['auction_image']) }}" alt="">
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    <span>{{ o['auction_title'][:35] }}{% if o['auction_title']|length > 35 %}...{% endif %}</span>
                                </div>
                            </td>
                            <td>{{ o['muse_name'] or 'N/A' }}</td>
                            <td class="price-cell">${{ "%.2f"|format(o['amount']) }}</td>
                            <td>
                                <span class="status-badge status-{{ o['payment_status'] }}">{{ o['payment_status']|upper }}</span>
                                {% if o['shipment_status'] %}
                                <br><small class="text-muted">Ship: {{ o['shipment_status'] }}</small>
                                {% endif %}
                            </td>
                            <td class="actions-cell">
                                <a href="{{ url_for('admin_order_detail', payment_id=o['payment_id']) }}" class="action-btn" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% if o['payment_status'] == 'pending' %}
                                <a href="{{ url_for('admin_order_detail', payment_id=o['payment_id']) }}" class="action-btn action-verify" title="Verify Payment">
                                    <i class="fas fa-check-circle"></i>
                                </a>
                                {% elif o['payment_status'] == 'paid' %}
                                <a href="{{ url_for('admin_order_detail', payment_id=o['payment_id']) }}" class="action-btn action-ship" title="Ship Order">
                                    <i class="fas fa-truck"></i>
                                </a>
                                {% elif o['payment_status'] == 'shipped' %}
                                <a href="{{ url_for('admin_order_detail', payment_id=o['payment_id']) }}" class="action-btn action-deliver" title="Mark Delivered">
                                    <i class="fas fa-box-open"></i>
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

    </div>
    {% endif %}

    <!-- Auctions Table -->
    <div class="admin-section">
        <h2>All Auctions</h2>
        <div class="table-wrapper">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Image</th>
                        <th>Title</th>
                        <th>Muse</th>
                        <th>Status</th>
                        <th>Current Bid</th>
                        <th>Bids</th>
                        <th>High Bidder</th>
                        <th>Ends At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for a in auctions %}
                    <tr class="{% if a['status'] == 'live' %}row-live{% elif a['status'] == 'ended' %}row-ended{% else %}row-draft{% endif %}">
                        <td>{{ a['id'] }}</td>
                        <td>
                            {% if a['image'] %}
                            <div class="table-thumb">
                                {% if a['image'].startswith('uploads/') %}
                                <img src="{{ url_for('static', filename=a['image']) }}" alt="">
                                {% else %}
                                <img src="{{ url_for('static', filename='images/' + a['image']) }}" alt="">
                                {% endif %}
                            </div>
                            {% endif %}
                        </td>
                        <td><strong>{{ a['title'] }}</strong></td>
                        <td>{{ a['muse_name'] or 'N/A' }}</td>
                        <td>
                            <span class="status-badge status-{{ a['status'] }}">{{ a['status']|upper }}</span>
                        </td>
                        <td class="price-cell">${{ "%.2f"|format(a['current_bid'] or a['starting_bid']) }}</td>
                        <td>{{ a['bid_count'] }}</td>
                        <td>{{ a['bidder_name'] or '&mdash;' }}</td>
                        <td>
                            {% if a['status'] == 'live' %}
                            <span class="countdown-mini" data-ends-at="{{ a['ends_at'] }}">--</span>
                            {% else %}
                            <span class="text-muted">{{ a['ends_at'][:16] }}</span>
                            {% endif %}
                        </td>
                        <td class="actions-cell">
                            <a href="{{ url_for('admin_auction_edit', auction_id=a['id']) }}" class="action-btn edit" title="Edit"><i class="fas fa-edit"></i></a>
                            <a href="{{ url_for('admin_auction_bids', auction_id=a['id']) }}" class="action-btn" title="View Bids"><i class="fas fa-list"></i></a>
                            {% if a['status'] == 'live' %}
                            <form method="POST" action="{{ url_for('admin_auction_extend', auction_id=a['id']) }}" style="display:inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="minutes" value="30">
                                <button type="submit" class="action-btn extend" title="Extend 30min"><i class="fas fa-clock"></i></button>
                            </form>
                            <form method="POST" action="{{ url_for('admin_auction_end', auction_id=a['id']) }}" style="display:inline;"
                                  onsubmit="return confirm('End this auction now?')">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="action-btn danger" title="End Now"><i class="fas fa-stop"></i></button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Mini countdowns for admin table
function initAdminCountdowns() {
    const els = document.querySelectorAll('.countdown-mini[data-ends-at]');
    if (!els.length) return;

    function update() {
        const now = Date.now();
        els.forEach(el => {
            const endsAt = new Date(el.dataset.endsAt).getTime();
            const diff = endsAt - now;
            if (diff <= 0) {
                el.textContent = 'ENDED';
                el.classList.add('text-danger');
                return;
            }
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            el.textContent = `${h}h ${m}m ${s}s`;
            if (diff < 300000) el.classList.add('text-danger');
        });
    }
    update();
    setInterval(update, 1000);
}
initAdminCountdowns();
</script>
{% endblock %}
